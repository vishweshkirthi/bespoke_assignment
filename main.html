<!DOCTYPE html>
<html>
<head>
    <title>Document Quality Classifier</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .spinner { 
            border: 2px solid #f3f3f3; 
            border-top: 2px solid #ffffff; 
            border-radius: 50%; 
            width: 16px; 
            height: 16px; 
            animation: spin 1s linear infinite; 
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .high-quality { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .low-quality { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        textarea { width: 100%; height: 100px; margin: 10px 0; }
        input[type="file"] { margin: 10px 0; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status.loading { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h1>Document Quality Classifier</h1>
    
    <div class="section">
        <h2>Model Management</h2>
        <div id="modelStatus">Checking...</div>
        
        <h3>Select Model</h3>
        <select id="modelSelect" style="width: 300px; padding: 8px; margin: 10px 0;">
            <option value="">Loading models...</option>
        </select>
        <button class="button" onclick="selectModel()" id="selectModelButton">Load Selected Model</button>
        <button class="button" onclick="refreshModels()" style="background: #6c757d;">Refresh Models</button>
    </div>
    
    <div class="section">
        <h2>Train Model</h2>
        <p><strong>Training file:</strong> Upload positive examples (format: __label__high [text]):</p>
        <input type="file" id="trainingFile" accept=".txt">
        
        <p><strong>Validation file (optional):</strong> Enable FastText autotune for hyperparameter optimization:</p>
        <input type="file" id="validationFile" accept=".txt">
        <label>
            <input type="checkbox" id="useAutotune"> Use autotune (takes longer but may improve accuracy)
        </label>
        <br><br>
        
        <button class="button" onclick="trainModel()" id="trainButton">Train Model</button>
        <div id="trainingInfo" style="display: none; margin-top: 10px; padding: 10px; background: #e8f4fd; border: 1px solid #b8daff; border-radius: 5px;">
            <div id="modelUUID"></div>
            <div id="trainingStatus"></div>
        </div>
    </div>
    
    <div class="section">
        <h2>Score Text</h2>
        
        <h3>Single Text Scoring</h3>
        <p><strong>Requirements:</strong> 50+ characters, minimum 10 words</p>
        <textarea id="textInput" placeholder="Enter text to score for quality... (minimum 50 characters, 10 words)"></textarea>
        <div id="textStats" style="font-size: 12px; color: #666; margin: 5px 0;">Characters: 0 | Words: 0</div>
        <button class="button" onclick="scoreText()" id="scoreButton">Score Text</button>
        <div id="scoreResult"></div>
        
        <h3>Batch Scoring</h3>
        <p>Upload a text file for batch scoring. Format: <code>__label__high [text]</code> or just <code>[text]</code></p>
        <input type="file" id="batchFile" accept=".txt" style="margin: 10px 0;">
        <button class="button" onclick="scoreBatch()" id="batchScoreButton">Score Batch File</button>
        <div id="batchResults"></div>
    </div>
    
    <script>
        let socket = null;
        
        function connectWebSocket() {
            socket = new WebSocket('ws://localhost:8000/ws');
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                updateTrainingProgress(data);
            };
            
            socket.onclose = function() {
                console.log('WebSocket connection closed');
            };
        }
        
        function updateTrainingProgress(status) {
            const trainButton = document.getElementById('trainButton');
            const trainingInfo = document.getElementById('trainingInfo');
            const modelUUID = document.getElementById('modelUUID');
            const trainingStatusDiv = document.getElementById('trainingStatus');
            
            if (status.is_training) {
                trainButton.disabled = true;
                trainButton.innerHTML = '<div class="spinner"></div>Training...';
                
                // Show training info
                trainingInfo.style.display = 'block';
                if (status.model_uuid) {
                    modelUUID.innerHTML = `<strong>Model UUID:</strong> ${status.model_uuid}`;
                }
                if (status.message) {
                    trainingStatusDiv.innerHTML = `<strong>Status:</strong> ${status.message}`;
                }
            } else {
                trainButton.disabled = false;
                trainButton.innerHTML = 'Train Model';
                
                if (status.progress === 100) {
                    // Training completed - auto-refresh models and hide info after delay
                    refreshModels();
                    setTimeout(() => {
                        trainingInfo.style.display = 'none';
                    }, 5000);
                }
            }
        }
        
        async function checkModelStatus() {
            try {
                const response = await fetch('/model/status');
                const data = await response.json();
                
                const statusDiv = document.getElementById('modelStatus');
                if (data.status === 'loaded') {
                    statusDiv.innerHTML = `<span class="status success">✓ Model loaded: ${data.model_name}</span>`;
                } else {
                    statusDiv.innerHTML = '<span class="status error">✗ No model loaded. Please train or select a model.</span>';
                }
            } catch (error) {
                document.getElementById('modelStatus').innerHTML = '<span class="status error">Error checking status</span>';
            }
        }
        
        async function refreshModels() {
            try {
                const response = await fetch('/models');
                const data = await response.json();
                
                const modelSelect = document.getElementById('modelSelect');
                modelSelect.innerHTML = '';
                
                if (data.models.length === 0) {
                    modelSelect.innerHTML = '<option value="">No models found</option>';
                    document.getElementById('selectModelButton').disabled = true;
                } else {
                    modelSelect.innerHTML = '<option value="">Select a model...</option>';
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = `${model.display_name} (${model.size_mb}MB) - ${model.created_at}`;
                        if (model.id === data.current_model) {
                            option.selected = true;
                            option.textContent += ' ★ CURRENT';
                        }
                        modelSelect.appendChild(option);
                    });
                    document.getElementById('selectModelButton').disabled = false;
                }
            } catch (error) {
                console.error('Error loading models:', error);
                document.getElementById('modelSelect').innerHTML = '<option value="">Error loading models</option>';
            }
        }
        
        async function selectModel() {
            const modelSelect = document.getElementById('modelSelect');
            const selectedModel = modelSelect.value;
            
            if (!selectedModel) {
                alert('Please select a model');
                return;
            }
            
            const selectButton = document.getElementById('selectModelButton');
            selectButton.disabled = true;
            selectButton.innerHTML = '<div class="spinner"></div>Loading...';
            
            try {
                const response = await fetch('/model/select', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({model_id: selectedModel})
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Model loaded:', data);
                    
                    // Refresh status and models list
                    await checkModelStatus();
                    await refreshModels();
                    
                    alert(`Successfully loaded model: ${selectedModel}`);
                } else {
                    const error = await response.text();
                    alert(`Failed to load model: ${error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                selectButton.disabled = false;
                selectButton.innerHTML = 'Load Selected Model';
            }
        }
        
        async function trainModel() {
            const fileInput = document.getElementById('trainingFile');
            const validationFileInput = document.getElementById('validationFile');
            const useAutotuneCheckbox = document.getElementById('useAutotune');
            const trainButton = document.getElementById('trainButton');
            
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a training file');
                return;
            }
            
            // Show spinner immediately
            trainButton.disabled = true;
            trainButton.innerHTML = '<div class="spinner"></div>Training...';
            
            const formData = new FormData();
            formData.append('file', file);
            
            // Add validation file if autotune is enabled and file is selected
            if (useAutotuneCheckbox.checked) {
                const validationFile = validationFileInput.files[0];
                if (!validationFile) {
                    alert('Please select a validation file for autotune or uncheck the autotune option');
                    trainButton.disabled = false;
                    trainButton.innerHTML = 'Train Model';
                    return;
                }
                formData.append('validation_file', validationFile);
            }
            
            try {
                const response = await fetch('/train', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Training started:', data);
                    
                    // Show training info immediately
                    const trainingInfo = document.getElementById('trainingInfo');
                    const modelUUID = document.getElementById('modelUUID');
                    const trainingStatusDiv = document.getElementById('trainingStatus');
                    
                    trainingInfo.style.display = 'block';
                    modelUUID.innerHTML = `<strong>Model UUID:</strong> ${data.message.split('UUID: ')[1] || 'Generating...'}`;
                    trainingStatusDiv.innerHTML = `<strong>Status:</strong> Starting training with ${data.training_examples} examples...`;
                    
                    if (data.autotune_used) {
                        console.log('Using FastText autotune for hyperparameter optimization');
                    }
                } else {
                    const error = await response.text();
                    alert('Training failed: ' + error);
                    // Reset button on error
                    trainButton.disabled = false;
                    trainButton.innerHTML = 'Train Model';
                }
            } catch (error) {
                alert('Error: ' + error.message);
                // Reset button on error
                trainButton.disabled = false;
                trainButton.innerHTML = 'Train Model';
            }
        }
        
        function updateTextStats() {
            const text = document.getElementById('textInput').value;
            const charCount = text.length;
            const wordCount = text.trim().split(/\s+/).filter(word => word.length > 0).length;
            
            const statsDiv = document.getElementById('textStats');
            const isValid = charCount >= 50 && wordCount >= 10;
            
            statsDiv.innerHTML = `Characters: ${charCount} | Words: ${wordCount}`;
            statsDiv.style.color = isValid ? '#28a745' : '#dc3545';
            
            const button = document.getElementById('scoreButton');
            button.disabled = !isValid || text.trim() === '';
        }
        
        async function scoreText() {
            const text = document.getElementById('textInput').value.trim();
            
            // Client-side validation
            if (!text) {
                alert('Please enter some text');
                return;
            }
            
            if (text.length < 50) {
                alert('Text must be at least 50 characters long');
                return;
            }
            
            const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
            if (wordCount < 10) {
                alert('Text must contain at least 10 words');
                return;
            }
            
            const button = document.getElementById('scoreButton');
            button.disabled = true;
            button.textContent = 'Scoring...';
            
            try {
                const response = await fetch('/score', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({text: text})
                });
                
                const resultDiv = document.getElementById('scoreResult');
                
                if (response.ok) {
                    const data = await response.json();
                    const qualityClass = data.is_high_quality ? 'high-quality' : 'low-quality';
                    const qualityText = data.is_high_quality ? 'HIGH QUALITY' : 'LOW QUALITY';
                    
                    resultDiv.innerHTML = `
                        <div class="result ${qualityClass}">
                            <strong>${qualityText}</strong><br>
                            Predicted: ${data.predicted_label}<br>
                            Confidence: ${(data.confidence * 100).toFixed(1)}%
                        </div>
                    `;
                } else {
                    const error = await response.text();
                    resultDiv.innerHTML = `<div class="result" style="background: #f8d7da; color: #721c24;">Error: ${error}</div>`;
                }
            } catch (error) {
                document.getElementById('scoreResult').innerHTML = `<div class="result" style="background: #f8d7da; color: #721c24;">Error: ${error.message}</div>`;
            } finally {
                button.disabled = false;
                button.textContent = 'Score Text';
            }
        }
        
        async function scoreBatch() {
            const fileInput = document.getElementById('batchFile');
            const file = fileInput.files[0];
            const button = document.getElementById('batchScoreButton');
            const resultsDiv = document.getElementById('batchResults');
            
            if (!file) {
                alert('Please select a file');
                return;
            }
            
            button.disabled = true;
            button.innerHTML = '<div class="spinner"></div>Scoring...';
            resultsDiv.innerHTML = '<div>Processing file...</div>';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/score/batch', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayBatchResults(data);
                } else {
                    const error = await response.text();
                    resultsDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">Error: ${error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">Error: ${error.message}</div>`;
            } finally {
                button.disabled = false;
                button.innerHTML = 'Score Batch File';
            }
        }
        
        function displayBatchResults(data) {
            const resultsDiv = document.getElementById('batchResults');
            let html = '<div style="margin-top: 15px;">';
            
            // Summary
            html += `<h4>Batch Scoring Results</h4>`;
            html += `<p><strong>Total Documents:</strong> ${data.total_documents}</p>`;
            
            // Metrics if available
            if (data.metrics) {
                html += `<div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 10px 0;">`;
                html += `<h4>Evaluation Metrics</h4>`;
                html += `<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">`;
                html += `<div><strong>Accuracy:</strong> ${(data.metrics.accuracy * 100).toFixed(1)}%</div>`;
                html += `<div><strong>Precision:</strong> ${(data.metrics.precision * 100).toFixed(1)}%</div>`;
                html += `<div><strong>Recall:</strong> ${(data.metrics.recall * 100).toFixed(1)}%</div>`;
                html += `<div><strong>F1-Score:</strong> ${(data.metrics.f1_score * 100).toFixed(1)}%</div>`;
                html += `</div>`;
                
                // Confusion Matrix
                const cm = data.metrics.confusion_matrix;
                html += `<div style="margin-top: 10px;">`;
                html += `<strong>Confusion Matrix:</strong>`;
                html += `<table style="border-collapse: collapse; margin: 5px 0;">`;
                html += `<tr><td></td><td style="padding: 5px; border: 1px solid #ccc;"><strong>Pred High</strong></td><td style="padding: 5px; border: 1px solid #ccc;"><strong>Pred Low</strong></td></tr>`;
                html += `<tr><td style="padding: 5px; border: 1px solid #ccc;"><strong>True High</strong></td><td style="padding: 5px; border: 1px solid #ccc;">${cm.tp}</td><td style="padding: 5px; border: 1px solid #ccc;">${cm.fn}</td></tr>`;
                html += `<tr><td style="padding: 5px; border: 1px solid #ccc;"><strong>True Low</strong></td><td style="padding: 5px; border: 1px solid #ccc;">${cm.fp}</td><td style="padding: 5px; border: 1px solid #ccc;">${cm.tn}</td></tr>`;
                html += `</table>`;
                html += `</div>`;
                html += `</div>`;
            }
            
            // Sample predictions (first 10)
            html += `<h4>Sample Predictions (first 10)</h4>`;
            const samples = data.predictions.slice(0, 10);
            
            samples.forEach(pred => {
                const bgColor = pred.error ? '#f8d7da' : 
                               pred.is_high_quality ? '#d4edda' : '#fff3cd';
                const textColor = pred.error ? '#721c24' : 
                                 pred.is_high_quality ? '#155724' : '#856404';
                
                html += `<div style="background: ${bgColor}; color: ${textColor}; padding: 10px; margin: 5px 0; border-radius: 5px;">`;
                html += `<div><strong>Line ${pred.line_number}:</strong> `;
                
                if (pred.error) {
                    html += `ERROR - ${pred.error}`;
                } else {
                    html += `${pred.predicted_label.toUpperCase()} (${(pred.confidence * 100).toFixed(1)}%)`;
                    if (pred.true_label) {
                        const correct = pred.predicted_label === pred.true_label ? '✓' : '✗';
                        html += ` | True: ${pred.true_label} ${correct}`;
                    }
                }
                html += `</div>`;
                html += `<div style="font-size: 12px; margin-top: 5px;">${pred.text}</div>`;
                html += `</div>`;
            });
            
            if (data.predictions.length > 10) {
                html += `<p><em>... and ${data.predictions.length - 10} more results</em></p>`;
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }
        
        // Initialize
        connectWebSocket();
        checkModelStatus();
        refreshModels();
        
        // Add real-time text validation
        document.getElementById('textInput').addEventListener('input', updateTextStats);
        updateTextStats(); // Initial call
    </script>
</body>
</html>